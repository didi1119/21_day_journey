<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éœè¬æ£®æ— - ä¸ƒæ—¥æ—…ç¨‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --forest-dark: #0a1f1b;
            --forest-deep: #1a3530;
            --forest-medium: #2d5449;
            --forest-light: #4a7c6e;
            --forest-mist: #7fa394;
            --cream: #faf8f5;
            --gold: #d4a574;
            --moss: #8b9556;
        }

        body {
            font-family: 'Noto Serif TC', 'Georgia', serif;
            background: linear-gradient(135deg, var(--forest-dark) 0%, var(--forest-deep) 100%);
            color: var(--cream);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* èƒŒæ™¯å‹•ç•« */
        .bg-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.3;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--gold);
            border-radius: 50%;
            animation: float 15s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) translateX(50px); }
        }

        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        /* å…¥å£é  */
        .welcome-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            animation: fadeIn 2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .logo {
            width: 120px;
            height: 120px;
            margin-bottom: 30px;
            background: radial-gradient(circle, var(--gold) 0%, var(--moss) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            animation: breathe 4s infinite ease-in-out;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            font-weight: 300;
            letter-spacing: 3px;
        }

        .subtitle {
            font-size: 1.2rem;
            margin-bottom: 40px;
            opacity: 0.9;
            line-height: 1.8;
        }

        .start-btn {
            background: linear-gradient(135deg, var(--gold) 0%, var(--moss) 100%);
            color: var(--forest-dark);
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            letter-spacing: 1px;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(212, 165, 116, 0.3);
        }

        /* æ—…ç¨‹é é¢ */
        .journey-screen {
            display: none;
            min-height: 100vh;
            padding: 40px 0;
        }

        .day-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .day-number {
            font-size: 1rem;
            color: var(--gold);
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        .day-title {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .day-theme {
            font-size: 1.1rem;
            opacity: 0.8;
            font-style: italic;
        }

        /* éŸ³é »æ’­æ”¾å™¨ */
        .audio-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .audio-player {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .play-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gold);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .play-btn:hover {
            transform: scale(1.1);
        }

        .play-btn svg {
            width: 24px;
            height: 24px;
            fill: var(--forest-dark);
        }

        .audio-progress {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }

        .progress-bar {
            height: 100%;
            background: var(--gold);
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .audio-time {
            min-width: 80px;
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* äº’å‹•å€åŸŸ */
        .interaction-area {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* æ¯æ—¥ç‰¹å®šäº’å‹•å…ƒä»¶ */
        .silence-recorder {
            text-align: center;
        }

        .sound-wave {
            width: 300px;
            height: 100px;
            margin: 20px auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .wave-bar {
            position: absolute;
            bottom: 0;
            width: 4px;
            background: var(--gold);
            animation: wave 1s infinite ease-in-out;
        }

        @keyframes wave {
            0%, 100% { height: 20%; }
            50% { height: 80%; }
        }

        .breath-canvas {
            width: 100%;
            max-width: 400px;
            height: 300px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            cursor: crosshair;
            position: relative;
        }

        /* åˆ†äº«å¡ç‰‡ */
        .share-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            text-align: center;
            display: none;
        }

        .share-card.show {
            display: block;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .share-img {
            width: 100%;
            max-width: 350px;
            height: 350px;
            margin: 0 auto 20px;
            background: var(--forest-medium);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .share-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .share-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--cream);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .share-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* ç·´ç¿’æé†’ */
        .practice-reminder {
            background: linear-gradient(135deg, var(--moss) 0%, var(--gold) 100%);
            color: var(--forest-dark);
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
            text-align: center;
        }

        .practice-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .practice-desc {
            line-height: 1.6;
        }

        /* å°èˆª */
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-btn {
            padding: 10px 25px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: var(--cream);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* é€²åº¦è¿½è¹¤ */
        .progress-dots {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 30px 0;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .dot.active {
            background: var(--gold);
            transform: scale(1.3);
        }

        .dot.completed {
            background: var(--moss);
        }

        /* å®Œæˆç•«é¢ */
        .completion-screen {
            display: none;
            min-height: 100vh;
            padding: 40px 0;
            text-align: center;
        }

        .passport {
            max-width: 500px;
            margin: 0 auto;
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.1) 0%, rgba(139, 149, 86, 0.1) 100%);
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 40px;
        }

        .passport-title {
            font-size: 1.8rem;
            margin-bottom: 30px;
            color: var(--gold);
        }

        .stamps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .stamp {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--moss);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            opacity: 0.8;
        }

        .invite-code {
            background: var(--forest-dark);
            padding: 15px;
            border-radius: 10px;
            margin-top: 30px;
            font-family: monospace;
            font-size: 1.2rem;
            letter-spacing: 3px;
            color: var(--gold);
        }
        /* éŸ³é »äº’å‹•æç¤º */
        @keyframes slideDown {
            from { 
                opacity: 0; 
                transform: translate(-50%, -20px);
            }
            to { 
                opacity: 1; 
                transform: translate(-50%, 0);
            }
        }
    </style>
</head>
<body>
    <!-- è¼‰å…¥éŸ³é »æ¨¡æ“¬å™¨å’Œåˆ†äº«å¡ç‰‡ç”Ÿæˆå™¨ -->
    <script src="./21-day-journey/days_v3/audio-simulator.js"></script>
    <script src="./21-day-journey/days_v3/share-card-generator.js"></script>
    <!-- èƒŒæ™¯ç²’å­ -->
    <div class="bg-particles" id="particles"></div>

    <div class="container">
        <!-- æ­¡è¿é é¢ -->
        <div class="welcome-screen" id="welcomeScreen">
            <div class="logo">ğŸŒ²</div>
            <h1>éœè¬æ£®æ—</h1>
            <p class="subtitle">
                ä¸ƒç‰‡è‘‰å­çš„ç¦®ç‰©<br>
                æ¯å¤©äº”åˆ†é˜ï¼Œé‡è¦‹çœŸå¯¦çš„è‡ªå·±
            </p>
            <button class="start-btn" onclick="startJourney()">é–‹å§‹æ—…ç¨‹</button>
        </div>

        <!-- æ—…ç¨‹é é¢ -->
        <div class="journey-screen" id="journeyScreen">
            <div class="day-header">
                <div class="day-number" id="dayNumber">ç¬¬ä¸€å¤©</div>
                <h2 class="day-title" id="dayTitle">è½è¦‹å¯‚éœ</h2>
                <p class="day-theme" id="dayTheme">åœ¨å™ªéŸ³ä¸­æ‰¾åˆ°å±¬æ–¼ä½ çš„é »ç‡</p>
            </div>

            <!-- é€²åº¦æŒ‡ç¤º -->
            <div class="progress-dots">
                <div class="dot" data-day="1"></div>
                <div class="dot" data-day="2"></div>
                <div class="dot" data-day="3"></div>
                <div class="dot" data-day="4"></div>
                <div class="dot" data-day="5"></div>
                <div class="dot" data-day="6"></div>
                <div class="dot" data-day="7"></div>
            </div>

            <!-- éŸ³é »å€åŸŸ -->
            <div class="audio-section">
                <div class="audio-player">
                    <button class="play-btn" id="playBtn" onclick="toggleAudio()">
                        <svg viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                    </button>
                    <div class="audio-progress" onclick="seekAudio(event)">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div class="audio-time">
                        <span id="currentTime">0:00</span> / <span id="duration">5:00</span>
                    </div>
                </div>
                <p style="text-align: center; margin-top: 10px; opacity: 0.7; font-size: 0.9rem;">
                    æˆ´ä¸Šè€³æ©Ÿï¼Œæ•ˆæœæ›´ä½³
                </p>
            </div>

            <!-- äº’å‹•å€åŸŸ -->
            <div class="interaction-area" id="interactionArea">
                <!-- å‹•æ…‹è¼‰å…¥æ¯æ—¥äº’å‹•å…§å®¹ -->
            </div>

            <!-- åˆ†äº«å¡ç‰‡ -->
            <div class="share-card" id="shareCard">
                <div class="share-img" id="shareImg">
                    <!-- å‹•æ…‹ç”Ÿæˆåˆ†äº«åœ–ç‰‡ -->
                </div>
                <p id="shareText">åœ¨å¯‚éœä¸­ï¼Œæˆ‘è½è¦‹äº†...</p>
                <div class="share-buttons">
                    <button class="share-btn" onclick="saveImage()">å„²å­˜åœ–ç‰‡</button>
                    <button class="share-btn" onclick="shareToSocial()">åˆ†äº«</button>
                </div>
            </div>

            <!-- æ¯æ—¥ç·´ç¿’ -->
            <div class="practice-reminder">
                <div class="practice-title">ä»Šæ—¥ç·´ç¿’</div>
                <div class="practice-desc" id="practiceDesc">
                    è¨­å®š3å€‹ã€Œå¯‚éœé¬§é˜ã€ï¼Œæ¯æ¬¡éŸ¿èµ·æ™‚åœä¸‹30ç§’ï¼Œåªæ˜¯è†è½
                </div>
            </div>

            <!-- å°èˆª -->
            <div class="navigation">
                <button class="nav-btn" id="prevBtn" onclick="previousDay()" disabled>å‰ä¸€å¤©</button>
                <button class="nav-btn" id="nextBtn" onclick="completeDay()">å®Œæˆä»Šæ—¥æ—…ç¨‹</button>
            </div>
        </div>

        <!-- å®Œæˆç•«é¢ -->
        <div class="completion-screen" id="completionScreen">
            <h1 style="margin-bottom: 30px;">æ­å–œå®Œæˆä¸ƒæ—¥æ—…ç¨‹ï¼</h1>
            <div class="passport">
                <div class="passport-title">ğŸŒ² æ£®æ—è­·ç…§ ğŸŒ²</div>
                <div class="stamps" id="stamps">
                    <!-- å‹•æ…‹ç”Ÿæˆå°ç«  -->
                </div>
                <p style="margin: 20px 0; line-height: 1.8;">
                    ä½ å·²æ”¶é›†ä¸ƒç‰‡è‘‰å­<br>
                    æ¯ä¸€ç‰‡éƒ½æ˜¯è›»è®Šçš„è­‰æ˜
                </p>
                <div class="invite-code">
                    é‚€è«‹ç¢¼ï¼šFOREST7
                </div>
                <p style="margin-top: 20px; opacity: 0.8; font-size: 0.9rem;">
                    åˆ†äº«çµ¦ä¸€å€‹ä½ æƒ³é‚€è«‹é€²å…¥æ£®æ—çš„äºº
                </p>
            </div>
            <button class="start-btn" style="margin-top: 40px;" onclick="enterDeepJourney()">
                é€²å…¥21å¤©æ·±åº¦æ—…ç¨‹
            </button>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–éŸ³é »æ¨¡æ“¬å™¨å’Œåˆ†äº«å¡ç‰‡ç”Ÿæˆå™¨
        let audioSimulator;
        let shareCardGenerator;
        
        // æ—…ç¨‹æ•¸æ“š
        const journeyData = {
            currentDay: 1,
            completedDays: [],
            dailyRecords: {},
            startDate: null
        };

        // æ¯æ—¥å…§å®¹é…ç½®
        const dailyContent = {
            1: {
                number: 'ç¬¬ä¸€å¤©',
                title: 'è½è¦‹å¯‚éœ',
                theme: 'åœ¨å™ªéŸ³ä¸­æ‰¾åˆ°å±¬æ–¼ä½ çš„é »ç‡',
                emoji: 'ğŸ”‡',
                practice: 'è¨­å®š3å€‹ã€Œå¯‚éœé¬§é˜ã€ï¼Œæ¯æ¬¡éŸ¿èµ·æ™‚åœä¸‹30ç§’ï¼Œåªæ˜¯è†è½',
                sharePrompt: 'åœ¨å¯‚éœä¸­ï¼Œæˆ‘è½è¦‹äº†...',
                interaction: 'silence'
            },
            2: {
                number: 'ç¬¬äºŒå¤©',
                title: 'å‘¼å¸çš„å½¢ç‹€',
                theme: 'è®“å‘¼å¸æˆç‚ºä½ çš„éŒ¨',
                emoji: 'ğŸƒ',
                practice: 'æ¯æ¬¡æ‹¿èµ·æ‰‹æ©Ÿå‰ï¼Œå…ˆå®Œæˆä¸€å€‹å®Œæ•´çš„æ·±å‘¼å¸',
                sharePrompt: 'åŸä¾†æˆ‘çš„å‘¼å¸ï¼Œæ˜¯é€™æ¨£çš„å½¢ç‹€',
                interaction: 'breath'
            },
            3: {
                number: 'ç¬¬ä¸‰å¤©',
                title: 'å¾®è§€å®‡å®™',
                theme: 'åœ¨å¾®å°ä¸­çœ‹è¦‹æµ©ç€š',
                emoji: 'ğŸ”',
                practice: 'ç”¨ã€Œå¾®è§€è¦–è§’ã€çœ‹3å€‹å¹³å¸¸å¿½ç•¥çš„ç´°ç¯€',
                sharePrompt: 'åœ¨ä¸€ç‰‡è‘‰è„ˆè£¡ï¼Œæˆ‘çœ‹è¦‹äº†å®‡å®™',
                interaction: 'micro'
            },
            4: {
                number: 'ç¬¬å››å¤©',
                title: 'æ¨¹çš„æ™ºæ…§',
                theme: 'å­¸ç¿’ã€Œåªæ˜¯å­˜åœ¨ã€çš„åŠ›é‡',
                emoji: 'ğŸŒ²',
                practice: 'ç·´ç¿’ã€Œæ¨¹çš„ç«™ç«‹ã€- ç­‰å¾…æ™‚ä¸æ»‘æ‰‹æ©Ÿï¼Œåªæ˜¯ç«™è‘—',
                sharePrompt: 'ä»Šå¤©ï¼Œæ¨¹å‘Šè¨´æˆ‘...',
                interaction: 'tree'
            },
            5: {
                number: 'ç¬¬äº”å¤©',
                title: 'æƒ…ç·’çš„é¡è‰²',
                theme: 'çœ‹è¦‹ä¸¦æ¥ç´æƒ…ç·’çš„æµå‹•',
                emoji: 'ğŸ¨',
                practice: 'è¨˜éŒ„3å€‹æ™‚åˆ»çš„æƒ…ç·’é¡è‰²è®ŠåŒ–',
                sharePrompt: 'æˆ‘çš„ä¸€å¤©ï¼Œå¾é€™å€‹é¡è‰²æµå‘é‚£å€‹é¡è‰²',
                interaction: 'emotion'
            },
            6: {
                number: 'ç¬¬å…­å¤©',
                title: 'æ„Ÿæ©çš„è¿´éŸ¿',
                theme: 'è®“æ„Ÿæ©ç”¢ç”Ÿæ¼£æ¼ª',
                emoji: 'ğŸ’«',
                practice: 'å°3å€‹äºº/äº‹/ç‰©èªªå‡ºæˆ–é»˜å¿µæ„Ÿè¬',
                sharePrompt: 'ä»Šå¤©æˆ‘æƒ³è¬è¬é‚£å€‹...',
                interaction: 'gratitude'
            },
            7: {
                number: 'ç¬¬ä¸ƒå¤©',
                title: 'è›»è®Šçš„è­‰æ˜',
                theme: 'çœ‹è¦‹7å¤©çš„ç´°å¾®æ”¹è®Š',
                emoji: 'ğŸ¦‹',
                practice: 'å¸¶è‘—ã€Œæ£®æ—ä¹‹çœ¼ã€éå®Œé€™ä¸€å¤©',
                sharePrompt: 'ä¸ƒå¤©ï¼Œæˆ‘æ”¶é›†äº†ä¸ƒç‰‡è‘‰å­',
                interaction: 'reflection'
            }
        };

        // åˆå§‹åŒ–
        window.onload = function() {
            // åˆå§‹åŒ–éŸ³é »æ¨¡æ“¬å™¨å’Œåˆ†äº«å¡ç‰‡ç”Ÿæˆå™¨
            audioSimulator = new AudioSimulator();
            shareCardGenerator = new ShareCardGenerator();
            
            // å‰µå»ºèƒŒæ™¯ç²’å­
            createParticles();
            
            // è¼‰å…¥ä¿å­˜çš„é€²åº¦
            loadProgress();
            
            // ç›£è½éŸ³é »äº’å‹•äº‹ä»¶
            window.addEventListener('audioInteraction', handleAudioInteraction);
            window.addEventListener('audioComplete', handleAudioComplete);
        };

        // å‰µå»ºèƒŒæ™¯ç²’å­
        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                container.appendChild(particle);
            }
        }

        // é–‹å§‹æ—…ç¨‹
        function startJourney() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('journeyScreen').style.display = 'block';
            
            if (!journeyData.startDate) {
                journeyData.startDate = new Date().toISOString();
                saveProgress();
            }
            
            loadDay(journeyData.currentDay);
        }

        // è¼‰å…¥ç‰¹å®šå¤©æ•¸
        function loadDay(day) {
            const content = dailyContent[day];
            
            // æ›´æ–°é ­éƒ¨
            document.getElementById('dayNumber').textContent = content.number;
            document.getElementById('dayTitle').textContent = content.title;
            document.getElementById('dayTheme').textContent = content.theme;
            
            // æ›´æ–°ç·´ç¿’æè¿°
            document.getElementById('practiceDesc').textContent = content.practice;
            
            // æ›´æ–°åˆ†äº«æ–‡å­—
            document.getElementById('shareText').textContent = content.sharePrompt;
            
            // æ›´æ–°é€²åº¦é»
            updateProgressDots();
            
            // è¼‰å…¥äº’å‹•å€åŸŸ
            loadInteraction(content.interaction);
            
            // æ›´æ–°å°èˆªæŒ‰éˆ•
            updateNavigation();
            
            // é‡ç½®éŸ³é »
            resetAudio();
            
            // è¨­ç½®éŸ³é »æ¨¡æ“¬å™¨çš„å¤©æ•¸
            if (audioSimulator) {
                audioSimulator.setDay(day);
            }
        }

        // è¼‰å…¥äº’å‹•å…§å®¹
        function loadInteraction(type) {
            const area = document.getElementById('interactionArea');
            area.innerHTML = '';
            
            switch(type) {
                case 'silence':
                    area.innerHTML = `
                        <div class="silence-recorder">
                            <p style="margin-bottom: 20px;">æ­£åœ¨è†è½...</p>
                            <div class="sound-wave">
                                ${Array(20).fill('').map((_, i) => 
                                    `<div class="wave-bar" style="left: ${i * 15}px; animation-delay: ${i * 0.1}s;"></div>`
                                ).join('')}
                            </div>
                            <input type="text" id="silenceInput" placeholder="æˆ‘è½è¦‹äº†..." 
                                style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); 
                                color: white; padding: 10px 20px; border-radius: 25px; width: 300px; margin-top: 20px;">
                        </div>
                    `;
                    break;
                    
                case 'breath':
                    area.innerHTML = `
                        <canvas id="breathCanvas" class="breath-canvas"></canvas>
                        <p style="margin-top: 20px;">ç”¨æ‰‹æŒ‡è·Ÿéš¨å‘¼å¸ç•«å‡ºå½¢ç‹€</p>
                    `;
                    setTimeout(initBreathCanvas, 100);
                    break;
                    
                case 'micro':
                    area.innerHTML = `
                        <div style="text-align: center;">
                            <div style="width: 300px; height: 300px; background: rgba(255,255,255,0.05); 
                                border-radius: 10px; margin: 0 auto 20px; display: flex; 
                                align-items: center; justify-content: center;">
                                <label for="photoUpload" style="cursor: pointer;">
                                    <div style="font-size: 48px;">ğŸ“·</div>
                                    <p>é»æ“Šæ‹ç…§æˆ–ä¸Šå‚³</p>
                                </label>
                                <input type="file" id="photoUpload" accept="image/*" style="display: none;" 
                                    onchange="handlePhotoUpload(event)">
                            </div>
                            <div id="photoPoem" style="font-style: italic; line-height: 1.8;"></div>
                        </div>
                    `;
                    break;
                    
                case 'tree':
                    area.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 80px; margin-bottom: 20px;">ğŸŒ²</div>
                            <p style="margin-bottom: 20px;">æ¨¹çµ¦ä½ çš„è¨Šæ¯ï¼š</p>
                            <input type="text" id="treeMessage" placeholder="æ…¢ä¸€é»ï¼Œæ·±å‘¼å¸..." 
                                style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); 
                                color: white; padding: 10px 20px; border-radius: 25px; width: 300px;">
                        </div>
                    `;
                    break;
                    
                case 'emotion':
                    area.innerHTML = `
                        <div style="text-align: center;">
                            <p>é¸æ“‡ä½ æ­¤åˆ»çš„é¡è‰²ï¼š</p>
                            <div style="display: flex; gap: 10px; justify-content: center; margin: 20px 0;">
                                ${['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8']
                                    .map(color => `
                                        <div onclick="selectColor('${color}')" 
                                            style="width: 40px; height: 40px; background: ${color}; 
                                            border-radius: 50%; cursor: pointer;"></div>
                                    `).join('')}
                            </div>
                            <div id="emotionGradient" style="width: 300px; height: 100px; 
                                border-radius: 10px; margin: 20px auto;"></div>
                        </div>
                    `;
                    break;
                    
                case 'gratitude':
                    area.innerHTML = `
                        <div style="text-align: center; max-width: 400px;">
                            <p style="margin-bottom: 20px;">å¯«ä¸€å°30ç§’çš„æ„Ÿè¬è¨Šæ¯ï¼š</p>
                            <textarea id="gratitudeMessage" placeholder="è¬è¬ä½ ..." 
                                style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); 
                                color: white; padding: 15px; border-radius: 10px; width: 100%; height: 120px; 
                                resize: none;"></textarea>
                            <div style="margin-top: 20px;">
                                <button class="share-btn" onclick="sendGratitude()">å‚³é€</button>
                                <button class="share-btn" onclick="keepGratitude()">ä¿å­˜åœ¨å¿ƒè£¡</button>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'reflection':
                    area.innerHTML = `
                        <div style="text-align: center;">
                            <p style="margin-bottom: 20px;">å¯«çµ¦21å¤©å¾Œçš„è‡ªå·±ï¼š</p>
                            <textarea id="futureLetter" placeholder="è¦ªæ„›çš„æœªä¾†çš„æˆ‘..." 
                                style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); 
                                color: white; padding: 15px; border-radius: 10px; width: 100%; max-width: 400px; 
                                height: 150px; resize: none;"></textarea>
                        </div>
                    `;
                    break;
            }
        }

        // åˆå§‹åŒ–å‘¼å¸ç•«å¸ƒ
        function initBreathCanvas() {
            const canvas = document.getElementById('breathCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            let drawing = false;
            let lastX = 0;
            let lastY = 0;
            
            ctx.strokeStyle = '#d4a574';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            function startDrawing(e) {
                drawing = true;
                const rect = canvas.getBoundingClientRect();
                lastX = (e.clientX || e.touches[0].clientX) - rect.left;
                lastY = (e.clientY || e.touches[0].clientY) - rect.top;
            }
            
            function draw(e) {
                if (!drawing) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                lastX = x;
                lastY = y;
            }
            
            function stopDrawing() {
                drawing = false;
            }
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
        }

        // éŸ³é »æ§åˆ¶ (ä½¿ç”¨éŸ³é »æ¨¡æ“¬å™¨)
        function toggleAudio() {
            if (!audioSimulator) return;
            
            const isPlaying = audioSimulator.toggle();
            const btn = document.getElementById('playBtn');
            
            if (isPlaying) {
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
            } else {
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
            }
        }

        function seekAudio(event) {
            if (!audioSimulator) return;
            
            const rect = event.currentTarget.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            audioSimulator.seek(percent);
        }

        function resetAudio() {
            if (!audioSimulator) return;
            
            audioSimulator.reset();
            document.getElementById('playBtn').innerHTML = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
        }

        // è™•ç†éŸ³é »äº’å‹•äº‹ä»¶
        function handleAudioInteraction(event) {
            const { action, prompt } = event.detail;
            
            // æ ¹æ“šäº’å‹•é¡å‹æ›´æ–°UI
            switch(action) {
                case 'close_notifications':
                    // å¯ä»¥æ·»åŠ è¦–è¦ºæç¤º
                    break;
                case 'start_drawing':
                    // é«˜äº®ç¹ªç•«å€åŸŸ
                    const canvas = document.getElementById('breathCanvas');
                    if (canvas) {
                        canvas.style.border = '2px solid #d4a574';
                        setTimeout(() => {
                            canvas.style.border = 'none';
                        }, 3000);
                    }
                    break;
                case 'take_photo':
                    // é«˜äº®æ‹ç…§æŒ‰éˆ•
                    const photoArea = document.querySelector('[for="photoUpload"]');
                    if (photoArea) {
                        photoArea.style.animation = 'pulse 2s';
                    }
                    break;
            }
        }

        // è™•ç†éŸ³é »å®Œæˆäº‹ä»¶
        function handleAudioComplete(event) {
            generateShareCard();
        }

        // ç”Ÿæˆåˆ†äº«å¡ç‰‡
        async function generateShareCard() {
            if (!shareCardGenerator) {
                // å¦‚æœç”Ÿæˆå™¨é‚„æ²’æº–å‚™å¥½ï¼Œä½¿ç”¨åŸå§‹æ–¹æ³•
                const card = document.getElementById('shareCard');
                const img = document.getElementById('shareImg');
                const day = journeyData.currentDay;
                const content = dailyContent[day];
                
                img.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 60px; margin-bottom: 20px;">${content.emoji}</div>
                        <p style="font-size: 1.2rem;">${content.title}</p>
                        <p style="opacity: 0.8; margin-top: 10px;">Day ${day} / 7</p>
                    </div>
                `;
                
                card.classList.add('show');
                return;
            }
            
            const card = document.getElementById('shareCard');
            const img = document.getElementById('shareImg');
            const day = journeyData.currentDay;
            
            // æ”¶é›†ç•¶æ—¥æ•¸æ“š
            const dayData = collectDayData();
            
            // ç”Ÿæˆåˆ†äº«å¡ç‰‡åœ–ç‰‡
            const imageUrl = await shareCardGenerator.generateCard(day, dayData);
            
            // é¡¯ç¤ºç”Ÿæˆçš„åœ–ç‰‡
            img.innerHTML = `<img src="${imageUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">`;
            
            card.classList.add('show');
        }
        
        // æ”¶é›†ç•¶æ—¥æ•¸æ“š
        function collectDayData() {
            const day = journeyData.currentDay;
            const data = {};
            
            switch(dailyContent[day].interaction) {
                case 'silence':
                    data.sound = document.getElementById('silenceInput')?.value || 'å¿ƒè·³çš„è²éŸ³';
                    break;
                case 'breath':
                    const canvas = document.getElementById('breathCanvas');
                    if (canvas) {
                        data.breathImage = canvas.toDataURL();
                    }
                    data.breathName = 'å¦‚æµ·æµªèˆ¬èµ·ä¼';
                    break;
                case 'micro':
                    data.poem = 'åœ¨ç´‹ç†çš„è¿·å®®è£¡\nè—è‘—æ™‚é–“çš„ç§˜å¯†';
                    break;
                case 'tree':
                    data.message = document.getElementById('treeMessage')?.value || 'æ…¢ä¸€é»ï¼Œæ·±å‘¼å¸';
                    break;
                case 'emotion':
                    const selectedColor = document.querySelector('[data-selected-color]');
                    data.colors = selectedColor ? [selectedColor.dataset.selectedColor] : ['#4ECDC4'];
                    break;
                case 'gratitude':
                    data.gratitude = document.getElementById('gratitudeMessage')?.value || 'è¬è¬ä»Šå¤©çš„ç¾å¥½';
                    break;
                case 'reflection':
                    data.letter = document.getElementById('futureLetter')?.value || '';
                    break;
            }
            
            return data;
        }

        // å®Œæˆç•¶æ—¥
        function completeDay() {
            const day = journeyData.currentDay;
            
            // ä¿å­˜ç•¶æ—¥è¨˜éŒ„
            saveDailyRecord();
            
            // æ¨™è¨˜ç‚ºå®Œæˆ
            if (!journeyData.completedDays.includes(day)) {
                journeyData.completedDays.push(day);
            }
            
            // ç”Ÿæˆåˆ†äº«å¡ç‰‡ï¼ˆå¦‚æœé‚„æ²’ç”Ÿæˆï¼‰
            if (!document.getElementById('shareCard').classList.contains('show')) {
                generateShareCard();
            }
            
            // é€²å…¥ä¸‹ä¸€å¤©æˆ–å®Œæˆ
            if (day < 7) {
                journeyData.currentDay = day + 1;
                saveProgress();
                
                setTimeout(() => {
                    loadDay(journeyData.currentDay);
                    document.getElementById('shareCard').classList.remove('show');
                }, 1500);
            } else {
                // å®Œæˆæ•´å€‹æ—…ç¨‹
                setTimeout(() => {
                    showCompletion();
                }, 1500);
            }
        }

        // ä¿å­˜ç•¶æ—¥è¨˜éŒ„
        function saveDailyRecord() {
            const day = journeyData.currentDay;
            const record = {};
            
            // æ ¹æ“šç•¶å¤©é¡å‹ä¿å­˜ä¸åŒæ•¸æ“š
            switch(dailyContent[day].interaction) {
                case 'silence':
                    record.sound = document.getElementById('silenceInput')?.value || '';
                    break;
                case 'breath':
                    const canvas = document.getElementById('breathCanvas');
                    if (canvas) {
                        record.breathImage = canvas.toDataURL();
                    }
                    break;
                case 'tree':
                    record.message = document.getElementById('treeMessage')?.value || '';
                    break;
                case 'emotion':
                    record.color = document.querySelector('[data-selected-color]')?.dataset.selectedColor || '';
                    break;
                case 'gratitude':
                    record.gratitude = document.getElementById('gratitudeMessage')?.value || '';
                    break;
                case 'reflection':
                    record.letter = document.getElementById('futureLetter')?.value || '';
                    break;
            }
            
            journeyData.dailyRecords[day] = record;
            saveProgress();
        }

        // é¡¯ç¤ºå®Œæˆç•«é¢
        function showCompletion() {
            document.getElementById('journeyScreen').style.display = 'none';
            document.getElementById('completionScreen').style.display = 'block';
            
            // ç”Ÿæˆå°ç« 
            const stampsContainer = document.getElementById('stamps');
            stampsContainer.innerHTML = '';
            
            for (let i = 1; i <= 7; i++) {
                const stamp = document.createElement('div');
                stamp.className = 'stamp';
                stamp.innerHTML = dailyContent[i].emoji;
                stamp.style.animationDelay = (i * 0.1) + 's';
                stampsContainer.appendChild(stamp);
            }
        }

        // å°èˆªåŠŸèƒ½
        function previousDay() {
            if (journeyData.currentDay > 1) {
                journeyData.currentDay--;
                loadDay(journeyData.currentDay);
            }
        }

        function updateNavigation() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.disabled = journeyData.currentDay === 1;
            
            if (journeyData.currentDay === 7) {
                nextBtn.textContent = 'å®Œæˆæ—…ç¨‹';
            } else if (journeyData.completedDays.includes(journeyData.currentDay)) {
                nextBtn.textContent = 'ä¸‹ä¸€å¤©';
            } else {
                nextBtn.textContent = 'å®Œæˆä»Šæ—¥æ—…ç¨‹';
            }
        }

        // æ›´æ–°é€²åº¦é»
        function updateProgressDots() {
            const dots = document.querySelectorAll('.dot');
            dots.forEach((dot, index) => {
                const day = index + 1;
                dot.classList.remove('active', 'completed');
                
                if (day === journeyData.currentDay) {
                    dot.classList.add('active');
                } else if (journeyData.completedDays.includes(day)) {
                    dot.classList.add('completed');
                }
            });
        }

        // å…¶ä»–äº’å‹•åŠŸèƒ½
        function selectColor(color) {
            // ç§»é™¤ä¹‹å‰çš„é¸æ“‡
            document.querySelectorAll('[data-selected-color]').forEach(el => {
                delete el.dataset.selectedColor;
                el.style.border = 'none';
            });
            
            // æ¨™è¨˜æ–°é¸æ“‡
            event.target.dataset.selectedColor = color;
            event.target.style.border = '3px solid white';
            
            // æ›´æ–°æ¼¸å±¤
            const gradient = document.getElementById('emotionGradient');
            if (gradient) {
                gradient.style.background = `linear-gradient(135deg, ${color} 0%, rgba(255,255,255,0.1) 100%)`;
            }
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // æ¨¡æ“¬AIè©©æ„è§£è®€
                const poems = [
                    'åœ¨ç´‹ç†çš„è¿·å®®è£¡\nè—è‘—æ™‚é–“çš„ç§˜å¯†',
                    'å¾®å°çš„å®‡å®™\næ­£åœ¨æ‚„æ‚„å‘¼å¸',
                    'æ¯ä¸€é“ç—•è·¡\néƒ½æ˜¯ç”Ÿå‘½çš„ç°½å',
                    'æ”¾å¤§ä¾†çœ‹\nä¸€åˆ‡éƒ½æ˜¯å¥‡è¹Ÿ'
                ];
                
                const poem = poems[Math.floor(Math.random() * poems.length)];
                document.getElementById('photoPoem').innerHTML = poem.replace(/\n/g, '<br>');
            }
        }

        function sendGratitude() {
            alert('æ„Ÿæ©å·²å‚³é€åˆ°å®‡å®™ä¸­ âœ¨');
            document.getElementById('gratitudeMessage').value = '';
        }

        function keepGratitude() {
            alert('æ„Ÿæ©å·²ä¿å­˜åœ¨å¿ƒè£¡ ğŸ’');
            document.getElementById('gratitudeMessage').value = '';
        }

        // å„²å­˜å’Œè¼‰å…¥é€²åº¦
        function saveProgress() {
            localStorage.setItem('forestJourney7', JSON.stringify(journeyData));
        }

        function loadProgress() {
            const saved = localStorage.getItem('forestJourney7');
            if (saved) {
                Object.assign(journeyData, JSON.parse(saved));
            }
        }

        // å„²å­˜åœ–ç‰‡
        async function saveImage() {
            if (!shareCardGenerator) {
                alert('åœ–ç‰‡ç”Ÿæˆå™¨å°šæœªæº–å‚™å¥½');
                return;
            }
            
            const dayData = collectDayData();
            const imageUrl = await shareCardGenerator.generateCard(journeyData.currentDay, dayData);
            
            // ä¸‹è¼‰åœ–ç‰‡
            shareCardGenerator.downloadImage(imageUrl, `forest-journey-day${journeyData.currentDay}.png`);
        }

        // åˆ†äº«åˆ°ç¤¾äº¤åª’é«”
        function shareToSocial() {
            const text = `æˆ‘æ­£åœ¨åƒèˆ‡éœè¬æ£®æ—çš„7æ—¥æ—…ç¨‹ï¼Œç¬¬${journeyData.currentDay}å¤©ï¼š${dailyContent[journeyData.currentDay].title}`;
            const url = window.location.href;
            
            // å¯ä»¥æ ¹æ“šä¸åŒå¹³å°èª¿æ•´
            if (navigator.share) {
                navigator.share({
                    title: 'éœè¬æ£®æ—',
                    text: text,
                    url: url
                });
            } else {
                // è¤‡è£½åˆ°å‰ªè²¼æ¿
                navigator.clipboard.writeText(text + ' ' + url);
                alert('åˆ†äº«é€£çµå·²è¤‡è£½');
            }
        }

        // é€²å…¥æ·±åº¦æ—…ç¨‹
        function enterDeepJourney() {
            window.location.href = './21-day-journey-v2.html';
        }
    </script>
</body>
</html>