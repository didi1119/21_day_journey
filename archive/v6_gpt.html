// Serene Forest Landing Page — CRO Copy v2 (Hormozi 強化)
// -------------------------------------------------------
// 目標：把「夢想結果 / 達成知覺可能性 / 時間 / 努力與犧牲」翻成對外易讀文案，
// 尤其首屏（Above the fold）5 秒內說清楚「對我有什麼好處」與「所以（讓你）」。

import React, { useEffect, useState } from "react";
import { motion } from "framer-motion";
import {
  ChevronRight,
  HeartHandshake,
  Leaf,
  Mail,
  MessageCircle,
  Music4,
  Share2,
  ShieldCheck,
  Sparkles,
  Stamp,
  Star,
  Timer,
  Trees,
  Users,
} from "lucide-react";

import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from "@/components/ui/accordion";

// ----------------------------------------
// helpers
// ----------------------------------------
const pushEvent = (name: string, data: Record<string, unknown> = {}) => {
  if (typeof window !== "undefined") {
    (window as any).dataLayer = (window as any).dataLayer || [];
    (window as any).dataLayer.push({ event: name, ...data });
  }
};

const Section = ({ id, className = "", children }: { id: string; className?: string; children: React.ReactNode }) => (
  <section id={id} className={`py-12 sm:py-16 ${className}`}>{children}</section>
);

const Stat = ({ label, value }: { label: string; value: string }) => (
  <div className="flex flex-col items-center sm:items-start">
    <div className="text-2xl font-semibold tracking-tight">{value}</div>
    <div className="text-xs text-muted-foreground mt-1">{label}</div>
  </div>
);

function ForestBackdrop() {
  return (
    <div className="absolute inset-0 -z-10 overflow-hidden">
      <div className="absolute inset-0 bg-gradient-to-b from-emerald-900/40 via-background to-background" />
      <svg className="absolute bottom-0 left-1/2 -translate-x-1/2 w-[1600px] h-[520px] opacity-60" viewBox="0 0 1600 520" fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="grad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stopColor="#064E3B" />
            <stop offset="100%" stopColor="transparent" />
          </linearGradient>
        </defs>
        {Array.from({ length: 7 }).map((_, i) => (
          <path key={i} d={`M0 ${420 + i * 12} C 200 ${360 + i * 10}, 400 ${420 + i * 12}, 600 ${380 + i * 12} S 1000 ${420 + i * 10}, 1600 ${420 + i * 12} V 520 H 0 Z`} fill="url(#grad)" />
        ))}
      </svg>
      <div className="absolute -right-24 -top-24 w-[420px] h-[420px] rounded-full blur-3xl bg-emerald-500/20" />
      <div className="absolute -left-24 top-32 w-[360px] h-[360px] rounded-full blur-3xl bg-teal-500/20" />
    </div>
  );
}

// ----------------------------------------
// AB 版：更對外的語言
// A：情緒入手 + 讓你（so that）
// B：時間量化 + 讓你（so that）
// ----------------------------------------
function useVariant() {
  if (typeof window === "undefined") return "A" as const;
  const v = new URLSearchParams(window.location.search).get("v");
  return v === "B" ? ("B" as const) : ("A" as const);
}

function Headline() {
  const v = useVariant();
  if (v === "B") {
    return (
      <>
        <h1 className="text-3xl sm:text-5xl font-semibold leading-tight tracking-tight" data-testid="headline">
          每天 3 分鐘，把一片森林帶進生活。
        </h1>
        <p className="mt-3 text-base sm:text-lg text-muted-foreground" data-testid="subheadline">
          加入 LINE 立刻啟動 7 天體驗：聲景＋小任務，讓你更快靜下來、與重要的人更靠近，也更願意走進真正的森林。
        </p>
      </>
    );
  }
  return (
    <>
      <h1 className="text-3xl sm:text-5xl font-semibold leading-tight tracking-tight" data-testid="headline">
        當生活太吵，給自己一片森林。
      </h1>
      <p className="mt-3 text-base sm:text-lg text-muted-foreground" data-testid="subheadline">
        立即加入 LINE，拿到迎新禮（祝福音＋數位護照），讓你更快安定、和人更靠近，假日真的走進森林。
      </p>
    </>
  );
}

export default function LandingPageCROCopyV2() {
  const [todayCount, setTodayCount] = useState(0);

  useEffect(() => {
    pushEvent("lp_view", { path: "/lp-cro-copy-v2" });
    const base = 220 + Math.floor(Math.random() * 140);
    let i = 0;
    const t = setInterval(() => {
      i += Math.ceil(base / 24);
      setTodayCount(Math.min(i, base));
      if (i >= base) clearInterval(t);
    }, 40);
    return () => clearInterval(t);
  }, []);

  const joinLine = () => {
    pushEvent("line_subscribe_click", { source: "hero" });
    window.location.href = "https://lin.ee/your_line_link"; // 替換成你的 LINE 官方連結
  };

  const startQuiz = () => {
    pushEvent("quiz_start", { source: "hero" });
    window.location.href = "/quiz?src=lp-cro-copy-v2";
  };

  return (
    <div className="min-h-screen bg-background text-foreground">
      {/* NAV */}
      <header className="sticky top-0 z-30 backdrop-blur supports-[backdrop-filter]:bg-background/60 border-b">
        <div className="mx-auto max-w-6xl px-4 h-14 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <Trees className="w-5 h-5 text-emerald-600" />
            <span className="font-semibold tracking-tight">靜謐森林 · Serene Forest</span>
            <Badge variant="secondary" className="ml-2 hidden sm:inline-flex">品牌入口</Badge>
          </div>
          <div className="hidden sm:flex items-center gap-2">
            <Button variant="ghost" className="text-sm" onClick={() => document.getElementById("brand")?.scrollIntoView({ behavior: "smooth" })}>{'品牌是什麼？'}</Button>
            <Button variant="ghost" className="text-sm" onClick={() => document.getElementById("value")?.scrollIntoView({ behavior: "smooth" })}>{'你會得到'}</Button>
            <Button variant="ghost" className="text-sm" onClick={() => document.getElementById("how")?.scrollIntoView({ behavior: "smooth" })}>{'怎麼運作'}</Button>
            <Button className="text-sm" onClick={joinLine} data-testid="btn-join-line-nav">加入 LINE</Button>
            <Button variant="outline" className="text-sm" onClick={startQuiz} data-testid="btn-start-quiz-nav">開始測驗</Button>
          </div>
        </div>
      </header>

      {/* HERO / Above the Fold */}
      <div className="relative">
        <ForestBackdrop />
        <Section id="hero" className="pt-10 sm:pt-16 pb-6">
          <div className="mx-auto max-w-6xl px-4 grid sm:grid-cols-2 gap-8 items-center">
            <div>
              <motion.div initial={{ opacity: 0, y: 8 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5 }}>
                <Headline />
              </motion.div>

              {/* 好處 bullets：3 個外顯「讓你」 */}
              <div className="mt-4 flex flex-wrap gap-2" data-testid="benefit-chips">
                <Badge variant="secondary" className="gap-1"><Sparkles className="w-3.5 h-3.5"/> 更快靜下來</Badge>
                <Badge variant="secondary" className="gap-1"><HeartHandshake className="w-3.5 h-3.5"/> 關係更靠近</Badge>
                <Badge variant="secondary" className="gap-1"><Trees className="w-3.5 h-3.5"/> 週末真的走進森林</Badge>
              </div>

              {/* CTA Row */}
              <div className="mt-6 flex flex-col sm:flex-row gap-3">
                <Button size="lg" className="h-11 px-6" onClick={joinLine} data-testid="btn-join-line-hero">
                  加入 LINE 拿迎新禮 <ChevronRight className="w-5 h-5 ml-2" />
                </Button>
                <Button variant="outline" size="lg" className="h-11 px-6" onClick={startQuiz} data-testid="btn-start-quiz-hero">
                  先做 60 秒測驗
                </Button>
              </div>

              {/* Risk reducers */}
              <div className="flex flex-wrap items-center gap-3 text-xs text-muted-foreground mt-3" data-testid="risk-row">
                <div className="flex items-center gap-1"><ShieldCheck className="w-4 h-4"/> 免費加入</div>
                <div className="flex items-center gap-1"><ShieldCheck className="w-4 h-4"/> 可隨時退出</div>
                <div className="flex items-center gap-1"><ShieldCheck className="w-4 h-4"/> 不打擾、不推銷</div>
              </div>

              {/* Time proof */}
              <div className="mt-6 flex items-center gap-6 text-sm text-muted-foreground" data-testid="proof-time">
                <Stat label="今日已互動" value={`${todayCount} 人`} />
                <div className="flex items-center gap-2"><Timer className="w-4 h-4" /> 60 秒開始 · 3 分鐘聽到第一份祝福音 · 7 天形成節奏</div>
              </div>
            </div>

            {/* Visual — 分享卡預覽 */}
            <motion.div initial={{ opacity: 0, scale: 0.96 }} animate={{ opacity: 1, scale: 1 }} transition={{ duration: 0.6 }} className="relative">
              <div className="aspect-[4/3] rounded-3xl bg-gradient-to-br from-emerald-200/60 to-teal-100/40 dark:from-emerald-900/20 dark:to-teal-900/10 p-3 shadow-inner overflow-hidden">
                <div className="h-full w-full rounded-2xl bg-white/70 dark:bg-white/5 border flex items-center justify-center">
                  <div className="w-[92%] max-w-xl aspect-[16/10] rounded-2xl border bg-gradient-to-br from-emerald-50 to-white dark:from-emerald-900/10 dark:to-zinc-900/20 p-4 flex flex-col justify-between">
                    <div className="flex items-center justify-between">
                      <Badge variant="secondary" className="gap-1"><Star className="w-3.5 h-3.5" /> 分享卡示例</Badge>
                      <div className="text-xs text-muted-foreground">可下載分享卡</div>
                    </div>
                    <div className="flex items-center gap-4">
                      <div className="w-20 h-20 rounded-xl bg-emerald-200/80 dark:bg-emerald-800/30 flex items-center justify-center"><Leaf className="w-10 h-10 text-emerald-700" /></div>
                      <div>
                        <div className="text-lg font-semibold">領航巨熊 · Explorer Bear</div>
                        <div className="text-sm text-muted-foreground">沉著 · 保護 · 向內對齊</div>
                      </div>
                    </div>
                    <div className="flex items-center justify-between">
                      <div className="text-xs text-muted-foreground">sereneforest.tw/quiz</div>
                      <Button size="sm" variant="outline" className="h-8 px-3"><Share2 className="w-3.5 h-3.5 mr-1" /> 預覽分享</Button>
                    </div>
                  </div>
                </div>
              </div>
            </motion.div>
          </div>
        </Section>
      </div>

      {/* 品牌是什麼（對外版） */}
      <Section id="brand" className="bg-muted/20">
        <div className="mx-auto max-w-6xl px-4">
          <div className="flex items-center gap-2 mb-3"><Badge variant="secondary">靜謐森林是什麼？</Badge></div>
          <h3 className="text-xl font-semibold tracking-tight">把森林帶進生活的療癒品牌</h3>
          <p className="mt-2 text-sm text-muted-foreground max-w-3xl">
            我們用「聲景、儀式、小任務」幫你在忙亂裡安定下來；也用「護照與印記」把線上收穫帶回實際旅程。
          </p>
          <div className="grid sm:grid-cols-3 gap-4 mt-6">
            <Card><CardHeader className="py-4"><CardTitle className="text-base flex items-center gap-2"><Sparkles className="w-4 h-4 text-emerald-600"/> 自我：更穩、更清楚</CardTitle></CardHeader><CardContent className="-mt-2 text-sm text-muted-foreground">每日 3 分鐘聲景與小任務，幫你重啟內在節奏。</CardContent></Card>
            <Card><CardHeader className="py-4"><CardTitle className="text-base flex items-center gap-2"><HeartHandshake className="w-4 h-4 text-emerald-600"/> 他人：更靠近</CardTitle></CardHeader><CardContent className="-mt-2 text-sm text-muted-foreground">夥伴小測驗與分享卡，讓對話更自然。</CardContent></Card>
            <Card><CardHeader className="py-4"><CardTitle className="text-base flex items-center gap-2"><Trees className="w-4 h-4 text-emerald-600"/> 自然：更常相遇</CardTitle></CardHeader><CardContent className="-mt-2 text-sm text-muted-foreground">護照 × 園區印記，真的走進森林，收集回憶。</CardContent></Card>
          </div>
          <div className="mt-5 flex gap-3">
            <Button onClick={joinLine} data-testid="btn-join-line-brand">加入 LINE 拿迎新禮</Button>
            <Button variant="outline" onClick={startQuiz} data-testid="btn-start-quiz-brand">先做 60 秒測驗</Button>
          </div>
        </div>
      </Section>

      {/* 你會得到（加入後立即） */}
      <Section id="value" className="bg-muted/40">
        <div className="mx-auto max-w-6xl px-4">
          <div className="flex items-center gap-2 mb-6"><Badge variant="secondary">加入後，你會立刻得到</Badge></div>
          <div className="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <Card className="shadow-sm hover:shadow-md transition-all"><CardHeader className="flex flex-row items-center gap-3 py-4"><div className="rounded-xl bg-emerald-50 dark:bg-emerald-950 p-2"><Music4 className="w-5 h-5 text-emerald-600"/></div><CardTitle className="text-base font-semibold">森林祝福音</CardTitle></CardHeader><CardContent className="text-sm text-muted-foreground -mt-2 pb-5">30–60 秒專屬聲景，幫你更快靜下來。</CardContent></Card>
            <Card className="shadow-sm hover:shadow-md transition-all"><CardHeader className="flex flex-row items-center gap-3 py-4"><div className="rounded-xl bg-emerald-50 dark:bg-emerald-950 p-2"><Stamp className="w-5 h-5 text-emerald-600"/></div><CardTitle className="text-base font-semibold">數位護照首枚印記</CardTitle></CardHeader><CardContent className="text-sm text-muted-foreground -mt-2 pb-5">到園區可兌換小禮，讓線上成果延伸到現實。</CardContent></Card>
            <Card className="shadow-sm hover:shadow-md transition-all"><CardHeader className="flex flex-row items-center gap-3 py-4"><div className="rounded-xl bg-emerald-50 dark:bg-emerald-950 p-2"><Users className="w-5 h-5 text-emerald-600"/></div><CardTitle className="text-base font-semibold">夥伴相容小測驗</CardTitle></CardHeader><CardContent className="text-sm text-muted-foreground -mt-2 pb-5">和重要的人一起玩，讓關係更靠近。</CardContent></Card>
            <Card className="shadow-sm hover:shadow-md transition-all"><CardHeader className="flex flex-row items-center gap-3 py-4"><div className="rounded-xl bg-emerald-50 dark:bg-emerald-950 p-2"><Leaf className="w-5 h-5 text-emerald-600"/></div><CardTitle className="text-base font-semibold">專屬角色報告</CardTitle></CardHeader><CardContent className="text-sm text-muted-foreground -mt-2 pb-5">用簡單標籤理解自己，帶走明天可做的一步。</CardContent></Card>
          </div>
        </div>
      </Section>

      {/* 三步驟（時間與努力清楚） */}
      <Section id="how">
        <div className="mx-auto max-w-6xl px-4">
          <div className="flex items-center gap-2 mb-8"><Badge variant="secondary">三步驟，開始你的旅程</Badge></div>
          <div className="grid sm:grid-cols-3 gap-4">
            <Card><CardHeader><CardTitle className="flex items-center gap-2"><MessageCircle className="w-5 h-5 text-emerald-600"/> 1. 加入 LINE 拿迎新禮</CardTitle></CardHeader><CardContent className="text-sm text-muted-foreground">免費加入、可隨時退出；先領祝福音與護照印記。</CardContent></Card>
            <Card><CardHeader><CardTitle className="flex items-center gap-2"><Timer className="w-5 h-5 text-emerald-600"/> 2. 60 秒小測驗</CardTitle></CardHeader><CardContent className="text-sm text-muted-foreground">完成 10 題立即出結果；下載分享卡，一起玩更好玩。</CardContent></Card>
            <Card><CardHeader><CardTitle className="flex items-center gap-2"><Trees className="w-5 h-5 text-emerald-600"/> 3. 走進真正的森林</CardTitle></CardHeader><CardContent className="text-sm text-muted-foreground">帶著護照到園區掃描印記換小禮，收集回憶。</CardContent></Card>
          </div>
        </div>
      </Section>

      {/* 社會證明 / 風險降低 */}
      <Section id="proof" className="bg-muted/40">
        <div className="mx-auto max-w-6xl px-4 grid lg:grid-cols-2 gap-6 items-center">
          <div>
            <div className="flex items-center gap-2 mb-3"><Badge variant="secondary">使用者回饋</Badge></div>
            <Card className="mb-3"><CardHeader className="py-4"><CardTitle className="text-base">「睡前聽祝福音，心就慢慢安靜下來了。」</CardTitle></CardHeader><CardContent className="text-sm text-muted-foreground">— Sherry，行銷 PM</CardContent></Card>
            <Card className="mb-3"><CardHeader className="py-4"><CardTitle className="text-base">「和伴侶玩小測驗，聊出了很久沒聊的事。」</CardTitle></CardHeader><CardContent className="text-sm text-muted-foreground">— Leo，產品設計</CardContent></Card>
            <Card><CardHeader className="py-4"><CardTitle className="text-base">「護照換到的小禮很可愛，想再回來。」</CardTitle></CardHeader><CardContent className="text-sm text-muted-foreground">— Vivian，自由工作者</CardContent></Card>
          </div>
          <div>
            <div className="grid sm:grid-cols-2 gap-3">
              <Card><CardHeader className="py-4"><CardTitle className="text-base flex items-center gap-2"><ShieldCheck className="w-4 h-4 text-emerald-600"/> 免費加入、隨時退出</CardTitle></CardHeader><CardContent className="-mt-2 text-sm text-muted-foreground">不綁定、不打擾；只想拿迎新禮也可以。</CardContent></Card>
              <Card><CardHeader className="py-4"><CardTitle className="text-base flex items-center gap-2"><ShieldCheck className="w-4 h-4 text-emerald-600"/> 隱私友善</CardTitle></CardHeader><CardContent className="-mt-2 text-sm text-muted-foreground">資料僅用於提供服務；你可一鍵取消。</CardContent></Card>
            </div>
            <div className="mt-4 flex gap-3">
              <Button onClick={joinLine}>加入 LINE</Button>
              <Button variant="outline" onClick={startQuiz}>先做 60 秒測驗</Button>
            </div>
          </div>
        </div>
      </Section>

      {/* CTA */}
      <Section id="cta">
        <div className="mx-auto max-w-6xl px-4 text-center">
          <h3 className="text-2xl font-semibold tracking-tight">現在就把森林帶進生活</h3>
          <p className="mt-2 text-sm text-muted-foreground">加入 LINE 拿迎新禮；想先體驗也可以做 60 秒小測驗。</p>
          <div className="mt-5 flex justify-center gap-3">
            <Button size="lg" onClick={joinLine} data-testid="btn-join-line-cta">加入 LINE <ChevronRight className="w-5 h-5 ml-2"/></Button>
            <Button size="lg" variant="outline" onClick={startQuiz} data-testid="btn-start-quiz-cta">先做 60 秒測驗</Button>
          </div>
        </div>
      </Section>

      {/* FAQ */}
      <Section id="faq" className="bg-muted/40">
        <div className="mx-auto max-w-6xl px-4">
          <div className="flex items-center gap-2 mb-3"><Badge variant="secondary">常見問題</Badge></div>
          <Accordion type="single" collapsible>
            <AccordionItem value="q1"><AccordionTrigger>這個 LP 和官網有什麼不同？</AccordionTrigger><AccordionContent className="text-sm text-muted-foreground">LP 專注於引流與體驗；官網聚焦空間介紹、房型與訂房流程。</AccordionContent></AccordionItem>
            <AccordionItem value="q2"><AccordionTrigger>不住宿也可以參與嗎？</AccordionTrigger><AccordionContent className="text-sm text-muted-foreground">可以。你可以只使用線上內容（祝福音、電子報、小測驗）。</AccordionContent></AccordionItem>
            <AccordionItem value="q3"><AccordionTrigger>如何兌換園區小禮？</AccordionTrigger><AccordionContent className="text-sm text-muted-foreground">在結果頁生成「數位護照」，到園區掃描指定印記即可兌換，效期 30 天。</AccordionContent></AccordionItem>
          </Accordion>
        </div>
      </Section>

      {/* Footer */}
      <footer className="border-t">
        <div className="mx-auto max-w-6xl px-4 py-10 grid sm:grid-cols-2 gap-4 items-center">
          <div className="text-sm text-muted-foreground">© {new Date().getFullYear()} 靜謐森林 Serene Forest. All rights reserved.</div>
          <div className="flex sm:justify-end gap-4 text-sm">
            <a className="text-muted-foreground hover:underline" href="/privacy">隱私</a>
            <a className="text-muted-foreground hover:underline" href="/terms">條款</a>
            <a className="text-muted-foreground hover:underline" href="/">官網</a>
          </div>
        </div>
      </footer>

      {/* Mobile sticky CTA */}
      <div className="fixed bottom-3 left-0 right-0 z-40 px-3 sm:hidden">
        <div className="mx-auto max-w-md rounded-2xl shadow-lg border bg-background/95 backdrop-blur p-2 flex gap-2">
          <Button className="flex-1" size="lg" onClick={joinLine}>加入 LINE</Button>
          <Button variant="outline" size="lg" onClick={startQuiz}>測驗</Button>
        </div>
      </div>
    </div>
  );
}

// -------------------------------------------------------
// 可見的 smoke tests（不影響 UI；確保首屏具備「讓你」主張）
// -------------------------------------------------------
if (typeof window !== "undefined") {
  setTimeout(() => {
    try {
      const headline = document.querySelector('[data-testid="headline"]');
      const sub = document.querySelector('[data-testid="subheadline"]');
      console.assert(!!headline && !!sub, "首屏標題或副標缺失");
      console.assert((sub as HTMLElement).innerText.includes("讓你"), "副標需包含『讓你』（so that）表述");
      const chips = document.querySelector('[data-testid="benefit-chips"]');
      console.assert(!!chips, "首屏好處 chips 缺失");
    } catch (e) {
      console.warn("Smoke tests warning: ", e);
    }
  }, 0);
}
